name: create-vps

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y tmate unzip openjdk-17-jre-headless wget
          curl -fsSL https://mega.nz/linux/MEGAcmdDebianSetup.sh | sudo bash
          sudo apt update && sudo apt install -y megacmd

      - name: Start tmate SSH
        run: |
          mkdir -p links
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' > links/ssh.txt
          cat links/ssh.txt

      - name: Login to MEGA
        env:
          MEGA_EMAIL: ${{ secrets.MEGA_EMAIL }}
          MEGA_PASSWORD: ${{ secrets.MEGA_PASSWORD }}
        run: |
          mega-login "$MEGA_EMAIL" "$MEGA_PASSWORD"

      - name: Download world & plugins backups from MEGA
        run: |
          mkdir -p minecraft/plugins
          mega-get /vps_backups/world.zip .
          mega-get /vps_backups/plugins.zip .

          if [ -f world.zip ]; then
            unzip world.zip -d minecraft/
          fi
          if [ -f plugins.zip ]; then
            unzip plugins.zip -d minecraft/plugins/
          fi

      - name: Download latest plugins from /plugins_source/
        run: |
          mkdir -p plugin_temp
          mega-ls /plugins_source/ | while read plugin; do
            mega-get "/plugins_source/$plugin" "plugin_temp/$plugin"
          done
          cp plugin_temp/* minecraft/plugins/ 2>/dev/null || true

      - name: Download Paper Server
        run: |
          cd minecraft
          wget https://api.papermc.io/v2/projects/paper/versions/1.20.1/builds/196/downloads/paper-1.20.1-196.jar -O server.jar
          echo "eula=true" > eula.txt
          echo -e "motd=Mega VPS Minecraft Server\nmax-players=10\nonline-mode=false" > server.properties

      - name: Start Minecraft Server
        run: |
          cd minecraft
          nohup java -Xmx2G -Xms1G -jar server.jar nogui &

      - name: Backup world & plugins to MEGA
        run: |
          cd minecraft
          zip -r world.zip world/
          zip -r plugins.zip plugins/
          mv world.zip ../
          mv plugins.zip ../
          cd ..
          mega-put world.zip /vps_backups/
          mega-put plugins.zip /vps_backups/

      - name: Keep VPS Alive
        run: |
          echo "âœ… VPS running for 6 hours with full auto features!"
          sleep $((6 * 60 * 60))
